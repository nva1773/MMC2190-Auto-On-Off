<h2 align="center">Автоматическое вкл\выкл автомагнитолы MMC 2190 от ключа зажигания.</h2>

### Папки и файлы:

    Firmware   файл с прошивкой микроконтроллера и картинка с битами конфигурации.
    Hard       электронная схема и фото с точками подключения устройства в ММС в формате jpg.
    Proteus    файлы для симуляции работы устройства в программе Proteus.
    Source     файлы с исходным кодом прораммы.
    README.md  этот файл.
    
### Цель проекта:

Реализация в штатной автомагнитоле MMC 2190 опции автоматического включения и выключения при повороте ключа зажигания (сигнал **ACC**).

ММС будет включаться и выключаться эмуляцией нажатия кнопки на передней панели. Для этого будет использован микроконтроллер PIC12F675.
> Активиция опции:
* при наличии **АСС**, включить ММС штатной кнопкой -> ММС будет включаться и выключатся от **АСС**.
> Деактивация опции:
* при наличии **АСС**, выключить ММС штатной кнопкой -> ММС больше не будет включаться от **АСС**.
---
> За основу была взята инструкция **CrazyDron**:
[Инструкция по реализации входа АСС.](https://4pda.ru/forum/index.php?s=&showtopic=625673&view=findpost&p=34145970)

> Автор проекта **Akhmed_d**, в его проекте еще реализованна функция управления подсветкой:
[MMC ACC + dimmer](https://4pda.ru/forum/index.php?showtopic=625673&st=11300#entry41871647)

> Большое спасибо **CrazyDron** за возможность использовать фото с точками подключения устройства в MMC 2190.
> ```
> Автор проекта использовал микроконтроллер PIC12F629, который от PIC12F675 отличается только отсутствием АЦП.
> В данном проекти АЦП не используется, но в наличии был 12F675, поэтому проект выполнен на нем.
> Также CrazyDron выложил три файла с прошивками контроллера, но к сожаленью нет исходных файлов,
> т.е. нет возможности изготовить устройство на другом контроллере, например на PIC12F675 или Atiny13.
> ```
---
### Программное обеспечение:

Учитывая выше изложенное, было принято решение написать свою программу на языке **Cи**.

> **Среда разработки** - MPLAB IDE V8 от компании MicroChip.

> **Компилятор** - CCS PCWH V4 + плагин для MPLAB.

### Схема подключения выводов PIC12F675:

![Электронная схема](https://github.com/nva1773/MMC2190-Auto-On-Off/blob/master/Hard/Circuit.JPG)

Были внесены изменения в номиналы резисторов по входам **D** и **C**, а также параллельно точки **ACC** в землю добавлен резистор 1К, для разряда конденсатора в цепи 12В->5В. На потребление тока в дежурном режиме не повлияет, т.к. цепь ACC при этом обесточенна.
 
1.  **A** - GND (земля)
2.  **NC** - не используется
3.  **NC** - не используется
4.  **MCLR** - не используется 
5.  **D** - Вход M5V, в этой точке появляется +5V при включенном ММС
6.  **C** - Вход АСС, в этой точке появляется +5V при наличии +12 на ACC
7.  **B** - Выход эмулирования нажатие кнопки включения/выключения питания ММС
8.  **E** - Питание PIC, +5V постоянно

На вывод **B** выдается логичесий 0 в течени 2 секунд для выключения и выключения ММС.
В остальное время, для уменьшения тока потребления, он находится в высокоимпедансном состоянии, т.е. настроеный как вход.

### Алгоритм работы:

Если сняты напряжения с точек **С** и **D**, контроллер спит, просыпается раз в секунду по сторожевому таймеру (WDT),
проверяет наличие напруги на **C** или **D** и опять засыпает, т.е. потребляет минимум энергии.

При появлении 1 на **С**, контролер просыпается и выдает логический 0 длительностью 2 сек на **В**, для включения ММС,
ждет появления 1 (сигнал что ММС включился) на **D** и переходит в рабочий режим.
В этом режиме, если снять АСС, контроллер выдаст логический 0 длит. 2 сек на **В**, для выключения ММС,
ждет логический 0 (сигнал что ММС выключился) на **D** и переходит в спящий режим.

Если контроллер просыпается только по сигналу на **D**, он понимает что ММС включили по кнопке питания, и запускает таймер обратного отсчета.
Через 60 минут ММС выключается выдав на **В** импульс эмуляции выключения.
Если в течении времени отсчета таймера появляется сиганл АСС, таймер деактивируется и ММС может быть выключено только с помощью кнопки на передней панели.
